From 0041d11bd6ee525f4ad59034186c7fba1d83f644 Mon Sep 17 00:00:00 2001
From: Roman Pustobaiev <roman@persimmons.ai>
Date: Tue, 10 Oct 2023 13:04:27 +0200
Subject: [PATCH] Patch

---
 arch/riscv/Kconfig                      |   4 +
 arch/riscv/dts/Makefile                 |   1 +
 arch/riscv/dts/occamy-u-boot.dtsi       |   1 +
 arch/riscv/dts/occamy.dts               | 165 ++++++++++++++++++++++++
 board/pulp-platform/occamy/Kconfig      |  31 +++++
 board/pulp-platform/occamy/Makefile     |   5 +
 board/pulp-platform/occamy/occamy.c     |   5 +
 board/pulp-platform/occamy/occamy_spl.c |  70 ++++++++++
 common/init/board_init.c                |   8 ++
 common/log.c                            |  19 +++
 common/spl/spl.c                        |   6 +-
 common/spl/spl_fit.c                    |   4 +-
 common/spl/spl_opensbi.c                |  10 +-
 configs/pulp-platform_occamy_defconfig  |  77 +++++++++++
 drivers/core/lists.c                    |  19 +--
 drivers/core/root.c                     |   6 +-
 include/configs/pulp-platform_occamy.h  |  39 ++++++
 include/init.h                          |   5 +
 include/log.h                           |   7 +
 lib/display_options.c                   |  10 +-
 lib/fdtdec.c                            |  12 +-
 lib/tiny-printf.c                       |  12 +-
 22 files changed, 487 insertions(+), 29 deletions(-)
 create mode 100644 arch/riscv/dts/occamy-u-boot.dtsi
 create mode 100644 arch/riscv/dts/occamy.dts
 create mode 100644 board/pulp-platform/occamy/Kconfig
 create mode 100644 board/pulp-platform/occamy/Makefile
 create mode 100644 board/pulp-platform/occamy/occamy.c
 create mode 100644 board/pulp-platform/occamy/occamy_spl.c
 create mode 100644 configs/pulp-platform_occamy_defconfig
 create mode 100644 include/configs/pulp-platform_occamy.h

diff --git a/arch/riscv/Kconfig b/arch/riscv/Kconfig
index b3d7fd84ce..d193ea497d 100644
--- a/arch/riscv/Kconfig
+++ b/arch/riscv/Kconfig
@@ -23,6 +23,9 @@ config TARGET_SIFIVE_UNLEASHED
 config TARGET_SIFIVE_UNMATCHED
 	bool "Support SiFive Unmatched Board"
 
+config TARGET_PULP_PLATFORM_OCCAMY
+	bool "Target Occamy Chiplet Architecture"
+
 config TARGET_SIPEED_MAIX
 	bool "Support Sipeed Maix Board"
 
@@ -61,6 +64,7 @@ source "board/microchip/mpfs_icicle/Kconfig"
 source "board/sifive/unleashed/Kconfig"
 source "board/sifive/unmatched/Kconfig"
 source "board/sipeed/maix/Kconfig"
+source "board/pulp-platform/occamy/Kconfig"
 
 # platform-specific options below
 source "arch/riscv/cpu/ax25/Kconfig"
diff --git a/arch/riscv/dts/Makefile b/arch/riscv/dts/Makefile
index 7778874831..04a0fccacf 100644
--- a/arch/riscv/dts/Makefile
+++ b/arch/riscv/dts/Makefile
@@ -6,6 +6,7 @@ dtb-$(CONFIG_TARGET_QEMU_VIRT) += qemu-virt.dtb
 dtb-$(CONFIG_TARGET_SIFIVE_UNLEASHED) += hifive-unleashed-a00.dtb
 dtb-$(CONFIG_TARGET_SIFIVE_UNMATCHED) += hifive-unmatched-a00.dtb
 dtb-$(CONFIG_TARGET_SIPEED_MAIX) += k210-maix-bit.dtb
+dtb-$(CONFIG_TARGET_PULP_PLATFORM_OCCAMY) += occamy.dtb
 
 targets += $(dtb-y)
 
diff --git a/arch/riscv/dts/occamy-u-boot.dtsi b/arch/riscv/dts/occamy-u-boot.dtsi
new file mode 100644
index 0000000000..aa7cdbfb18
--- /dev/null
+++ b/arch/riscv/dts/occamy-u-boot.dtsi
@@ -0,0 +1 @@
+#include "binman.dtsi"
diff --git a/arch/riscv/dts/occamy.dts b/arch/riscv/dts/occamy.dts
new file mode 100644
index 0000000000..25cb6bcdfc
--- /dev/null
+++ b/arch/riscv/dts/occamy.dts
@@ -0,0 +1,165 @@
+// Copyright 2021 ETH Zurich and University of Bologna.
+// Licensed under the Apache License, Version 2.0, see LICENSE for details.
+// SPDX-License-Identifier: Apache-2.0
+
+
+// TODO(niwis) ato generate
+/dts-v1/;
+/ {
+  #address-cells = <2>;
+  #size-cells = <2>;
+  compatible = "eth,occamy-dev";
+  model = "eth,occamy";
+  config {
+    u-boot,spl-payload-offset = <0xa000000>;
+  };
+  chosen {
+    stdout-path = "/soc/serial@2002000:115200";
+  };
+  memory@80000000 {
+    device_type = "memory";
+    reg = <0x0 0x80000000 0x0 0x20000000>;
+  };
+  // Create a reserved memory region for Snitch program memory
+  reserved-memory {
+    #address-cells = <2>;
+    #size-cells = <2>;
+    ranges;
+    snitch_mem: buffer@c0000000 {
+        reg = <0x0 0xc0000000 0x0 0x10000000>;
+    };
+  };
+  cpus {
+    #address-cells = <1>;
+    #size-cells = <0>;
+    timebase-frequency = <12500000>;
+    CPU0: cpu@0 {
+      device_type = "cpu";
+      status = "okay";
+      compatible = "eth,ariane", "riscv";
+      clock-frequency = <25000000>;
+      riscv,isa = "rv64fimafd";
+      mmu-type = "riscv,sv39";
+      tlb-split;
+      reg = <0>;
+      // represents the destination of the mcause bits
+      // ariane has 3 interrupt inputs:
+      // - software (ipi_i[0], IRQ_M_SOFT)
+      // - timer (time_irq_i[0], IRQ_M_TIMER)
+      // - external (irq_i[1:0], {IRQ_S_EXT, IRQ_M_EXT})
+      CPU0_intc: interrupt-controller {
+        #interrupt-cells = <1>;
+        #address-cells = <1>;
+        interrupt-controller;
+        compatible = "riscv,cpu-intc";
+      };
+    };
+  };
+  sysclk: virt_25mhz {
+    #clock-cells = <0>;
+    compatible = "fixed-clock";
+    clock-frequency = <25000000>;
+  };
+  soc: soc {
+    #address-cells = <2>;
+    #size-cells = <2>;
+    compatible = "simple-bus";
+    ranges;
+    debug@0 {
+      compatible = "riscv,debug-013";
+      // interrupts-extended = <&CPU0_intc 65535>;
+      reg-names = "control";
+      reg = <0x0 0x0 0x0 0x1000>;
+    };
+    serial@2002000 {
+      compatible = "ns16550a";
+      reg = <0x0 0x2002000 0x0 0x1000>;
+      clock-frequency = <25000000>;
+      current-speed = <115200>;
+      interrupt-parent = <&PLIC0>;
+      interrupts = <36>;
+      reg-offset = <0>;
+      reg-shift = <2>; // regs are spaced on 32 bit boundary
+      reg-io-width = <4>; // only 32-bit access are supported
+      // fifo-size = <64>;
+    };
+    timer@2006000 {
+      compatible = "pulp,apb_timer";
+      interrupt-parent = <&PLIC0>;
+      interrupts = <0x00000068 0x00000069 0x00000070 0x00000071>;
+      reg = <0x00000000 0x2006000 0x00000000 0x00001000>;
+      reg-names = "control";
+    };
+    ramdisk@0 {
+      partition@a0000000 {
+        label = "u-boot";
+        reg = <0xa0000000 0x100000>; // 1 MB
+        read-only;
+      };
+      uimage@a0100000 {
+        label = "uimage";
+        reg = <0xa0100000 0x1000000>; // 16 MB
+        read-only;
+      };
+      partition@a1100000 {
+        label = "filesystem";
+        reg = <0xa1100000 0x8f00000>; // 143 MB
+      };
+    };
+    clint0: clint@4000000 {
+      clock-frequency = <12500000>;
+      compatible = "riscv,clint0";
+      // clint generates software and timer interrupts to the core. Attach them
+      // to the CPU
+      // bits in mip and exception code in mcause:
+      // - IRQ_M_SOFT = 3: Machine software interrupt
+      // - IRQ_M_TIMER = 7: Machine timer interrupt
+      interrupts-extended = <&CPU0_intc 3 &CPU0_intc 7>;
+      reg-names = "clint";
+      reg = <0x0 0x4000000 0x0 0x100000>;
+    };
+    PLIC0: interrupt-controller@c000000 {
+      compatible = "riscv,plic0";
+      #address-cells = <0>;
+      #interrupt-cells = <1>;
+      interrupt-controller;
+      // PLIC generates external interrupts to the core, M and S mode
+      // - IRQ_M_EXT = 11: Machine external interrupt
+      // - IRQ_S_EXT = 9:  Supervisor external interrupt
+      interrupts-extended = <&CPU0_intc 11 &CPU0_intc 9>;
+      riscv,max-priority = <6>;
+      riscv,ndev = <72>;
+      reg = <0x0 0xc000000 0x0 0x4000000>;
+    };
+    soc_ctl0: soc-control@2000000 {
+      compatible = "eth,occamy-soc-control";
+      reg-names = "soc-control";
+      reg = <0x0 0x02000000 0x0 0x1000>;
+    };
+    quadrant_ctrl0: quadrant-control@b000000 {
+      compatible = "eth,occamy-quadrant-control";
+      reg-names = "quadrant-control";
+      reg = <0x0 0x0b000000 0x0 0x10000>;
+    };
+    // Instantiate a snitch cluster
+    snitch-cluster@10000000 {
+      compatible = "eth,snitch-cluster";
+      // TCDM and Peripheral spaces
+      reg-names = "tcdm", "peripheral";
+      reg = <0x0 0x10000000 0x0 0x20000>, <0x0 0x10020000 0x0 0x20000>;
+      // points to a memory region reserved for use by the cluster
+      memory-region = <&snitch_mem>;
+      // cluster specific properties
+      eth,compute-cores = <8>;
+      eth,dm-cores = <1>;
+      eth,quadrant-idx = <0>;
+      eth,cluster-idx = <0>; // Used to calculate offsets in clint, soc-ctrl etc..
+      // A handle to the soc-control register where isolates etc are located
+      eth,soc-ctl = <&soc_ctl0>;
+      // Handle to the associated quadrant controller
+      eth,quadrant-ctrl = <&quadrant_ctrl0>;
+      // handle to the clint where IPI interrupts are attached
+      eth,clint = <&clint0>;
+    };
+  };
+};
diff --git a/board/pulp-platform/occamy/Kconfig b/board/pulp-platform/occamy/Kconfig
new file mode 100644
index 0000000000..12e0bebe42
--- /dev/null
+++ b/board/pulp-platform/occamy/Kconfig
@@ -0,0 +1,31 @@
+if TARGET_PULP_PLATFORM_OCCAMY
+
+config SYS_BOARD
+	default "occamy"
+
+config SYS_VENDOR
+	default "pulp-platform"
+
+config SYS_CPU
+	default "generic"
+
+config SYS_CONFIG_NAME
+	default "pulp-platform_occamy"
+
+config SYS_TEXT_BASE
+	default 0x80200000 if SPL
+	default 0x80000000 if !RISCV_SMODE
+	default 0x80200000 if RISCV_SMODE
+
+config SPL_TEXT_BASE
+	default 0xb2000000
+
+config SPL_OPENSBI_LOAD_ADDR
+	default 0x80000000
+
+config BOARD_SPECIFIC_OPTIONS # dummy
+	def_bool y
+	select GENERIC_RISCV
+	select SUPPORT_SPL
+
+endif
diff --git a/board/pulp-platform/occamy/Makefile b/board/pulp-platform/occamy/Makefile
new file mode 100644
index 0000000000..fc8f63bbeb
--- /dev/null
+++ b/board/pulp-platform/occamy/Makefile
@@ -0,0 +1,5 @@
+obj-y	+= occamy.o
+
+ifdef CONFIG_SPL_BUILD
+obj-y += occamy_spl.o
+endif
diff --git a/board/pulp-platform/occamy/occamy.c b/board/pulp-platform/occamy/occamy.c
new file mode 100644
index 0000000000..d703634b1a
--- /dev/null
+++ b/board/pulp-platform/occamy/occamy.c
@@ -0,0 +1,5 @@
+#include <init.h>
+
+int board_init(void) { return 0; }
+
+int ft_board_setup(void *fdt, struct bd_info *bd) { return 0; }
diff --git a/board/pulp-platform/occamy/occamy_spl.c b/board/pulp-platform/occamy/occamy_spl.c
new file mode 100644
index 0000000000..8e7b36c8f8
--- /dev/null
+++ b/board/pulp-platform/occamy/occamy_spl.c
@@ -0,0 +1,70 @@
+#include <init.h>
+#include <spl.h>
+#include <misc.h>
+#include <log.h>
+#include <asm/spl.h>
+
+int spl_board_init_f(void)
+{
+	_occamy_puts("spl_board_init_f\n");
+
+	return 0;
+}
+
+u32 spl_boot_device(void)
+{
+	return BOOT_DEVICE_RAM;
+}
+
+#ifdef CONFIG_SPL_LOAD_FIT
+int board_fit_config_name_match(const char *name)
+{
+	/* boot using first FIT config */
+	return 0;
+}
+#endif
+
+void *memset(void *_ptr, int p, __kernel_size_t size)
+{
+	u8 * ptr = (u8 *)_ptr;
+	for (u32 i = 0; i < size; i++) {
+		ptr[i] = p;
+	}
+	return _ptr;
+}
+
+unsigned int get_log_size(void) {
+	unsigned int *_log_size = (unsigned int *)(OCCAMY_LOG_BASE);
+	return *_log_size;
+}
+
+void set_log_size(unsigned int size) {
+	unsigned int *_log_size = (unsigned int *)(OCCAMY_LOG_BASE);
+	*_log_size = *_log_size + size;
+}
+
+char *get_log_ptr (void) {
+	char *_log_ptr = (char *)(OCCAMY_LOG_BASE + 8 + get_log_size());
+	return _log_ptr;
+}
+
+int _occamy_putc (const char c) {
+	//Magic
+	char *log = get_log_ptr();
+	*log = c;
+	set_log_size(1);
+	return 0;
+}
+
+int _occamy_puts (const char *msg) {
+	unsigned int char_cnt = 0;
+	char *log = get_log_ptr();
+	while (*msg) {
+		*log = *msg;
+		log++;
+		msg++;
+		char_cnt++;
+	}
+	set_log_size(char_cnt);
+	return 0;
+}
\ No newline at end of file
diff --git a/common/init/board_init.c b/common/init/board_init.c
index 3f183ee113..c5ee064e4a 100644
--- a/common/init/board_init.c
+++ b/common/init/board_init.c
@@ -87,6 +87,11 @@ ulong board_init_f_alloc_reserve(ulong top)
 	return top;
 }
 
+void clear_log_size(void) {
+	unsigned int *_log_size = (unsigned int *)(OCCAMY_LOG_BASE);
+	*_log_size = 0;
+}
+
 /*
  * Initialize reserved space (which has been safely allocated on the C
  * stack from the C runtime environment handling code).
@@ -138,6 +143,9 @@ void board_init_f_init_reserve(ulong base)
 	 * Use gd_ptr, as gd may not be properly set yet.
 	 */
 
+	clear_log_size();
+	_occamy_puts("board_init_f_init_reserve\n");
+
 	gd_ptr = (struct global_data *)base;
 	/* zero the area */
 	memset(gd_ptr, '\0', sizeof(*gd));
diff --git a/common/log.c b/common/log.c
index ea407c6db9..25e73b1410 100644
--- a/common/log.c
+++ b/common/log.c
@@ -14,6 +14,24 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
+#define OCCAMY_LOG_BASE (0xc0000000)
+
+static unsigned int *_log_size = (unsigned int *)(OCCAMY_LOG_BASE);
+//static void *_log_base = (void*)(OCCAMY_LOG_BASE + sizeof(unsigned int));
+static char *_log_ptr = (char *)(OCCAMY_LOG_BASE + 8);
+
+int _occamy_puts (const char *msg) {
+	unsigned int char_cnt = 0;
+	while (*msg) {
+		*_log_ptr = *msg;
+		_log_ptr++;
+		msg++;
+		char_cnt++;
+	}
+	*_log_size = *_log_size + char_cnt;
+	return 0;
+}
+
 static const char *const log_cat_name[] = {
 	"none",
 	"arch",
@@ -269,6 +287,7 @@ int _log(enum log_category_t cat, enum log_level_t level, const char *file,
 			va_start(args, fmt);
 			vsnprintf(buf, sizeof(buf), fmt, args);
 			puts(buf);
+			//_occamy_puts(buf);
 			va_end(args);
 		}
 
diff --git a/common/spl/spl.c b/common/spl/spl.c
index a0a608fd77..b016d3014f 100644
--- a/common/spl/spl.c
+++ b/common/spl/spl.c
@@ -436,6 +436,7 @@ static int spl_common_init(bool setup_malloc)
 {
 	int ret;
 
+	debug("%s\n", __func__);
 #if CONFIG_VAL(SYS_MALLOC_F_LEN)
 	if (setup_malloc) {
 #ifdef CONFIG_MALLOC_F_ADDR
@@ -510,8 +511,10 @@ int spl_early_init(void)
 	debug("%s\n", __func__);
 
 	ret = spl_common_init(true);
-	if (ret)
+	if (ret) {
+		while (1) {}
 		return ret;
+	}
 	gd->flags |= GD_FLG_SPL_EARLY_INIT;
 
 	return 0;
@@ -731,6 +734,7 @@ void board_init_r(gd_t *dummy1, ulong dummy2)
 #ifdef CONFIG_CPU_V7M
 	spl_image.entry_point |= 0x1;
 #endif
+	debug("*** Preparing to jump : %d\n", spl_image.os);
 	switch (spl_image.os) {
 	case IH_OS_U_BOOT:
 		debug("Jumping to %s...\n", spl_phase_name(spl_next_phase()));
diff --git a/common/spl/spl_fit.c b/common/spl/spl_fit.c
index caddf51196..0acd204f98 100644
--- a/common/spl/spl_fit.c
+++ b/common/spl/spl_fit.c
@@ -312,11 +312,11 @@ static int spl_load_fit_image(struct spl_load_info *info, ulong sector,
 	}
 
 	if (CONFIG_IS_ENABLED(FIT_SIGNATURE)) {
-		printf("## Checking hash(es) for Image %s ... ",
+		debug("## Checking hash(es) for Image %s ... ",
 		       fit_get_name(fit, node, NULL));
 		if (!fit_image_verify_with_data(fit, node, src, length))
 			return -EPERM;
-		puts("OK\n");
+		debug("OK\n");
 	}
 
 	if (CONFIG_IS_ENABLED(FIT_IMAGE_POST_PROCESS))
diff --git a/common/spl/spl_opensbi.c b/common/spl/spl_opensbi.c
index 1c0abf8553..b39199527e 100644
--- a/common/spl/spl_opensbi.c
+++ b/common/spl/spl_opensbi.c
@@ -46,18 +46,19 @@ static int spl_opensbi_find_uboot_node(void *blob, int *uboot_node)
 void spl_invoke_opensbi(struct spl_image_info *spl_image)
 {
 	int ret, uboot_node;
-	ulong uboot_entry;
+	ulong uboot_entry = 0;
 	void (*opensbi_entry)(ulong hartid, ulong dtb, ulong info);
 
+	debug("spl_invoke_opensbi: opensbi_entry=%p\n", spl_image->entry_point);
+
 	if (!spl_image->fdt_addr) {
-		pr_err("No device tree specified in SPL image\n");
+		debug("No device tree specified in SPL image\n");
 		hang();
 	}
-
 	/* Find U-Boot image in /fit-images */
 	ret = spl_opensbi_find_uboot_node(spl_image->fdt_addr, &uboot_node);
 	if (ret) {
-		pr_err("Can't find U-Boot node, %d\n", ret);
+		debug("Can't find U-Boot node, %d\n", ret);
 		hang();
 	}
 
@@ -94,6 +95,7 @@ void spl_invoke_opensbi(struct spl_image_info *spl_image)
 	if (ret)
 		hang();
 #endif
+	debug("Invoking OPENSBI\n");
 	opensbi_entry(gd->arch.boot_hart, (ulong)spl_image->fdt_addr,
 		      (ulong)&opensbi_info);
 }
diff --git a/configs/pulp-platform_occamy_defconfig b/configs/pulp-platform_occamy_defconfig
new file mode 100644
index 0000000000..6cd883e169
--- /dev/null
+++ b/configs/pulp-platform_occamy_defconfig
@@ -0,0 +1,77 @@
+CONFIG_RISCV=y
+CONFIG_SYS_MALLOC_F_LEN=0x3000
+#CONFIG_DM_GPIO is not set
+#CONFIG_SPL_DM_SPI is not set
+CONFIG_SPL=y
+#CONFIG_SPL_SPI_FLASH_SUPPORT is not set
+#CONFIG_SPL_SPI_SUPPORT is not set
+CONFIG_DEFAULT_DEVICE_TREE="occamy"
+CONFIG_TARGET_PULP_PLATFORM_OCCAMY=y
+CONFIG_ARCH_RV64I=y
+CONFIG_RISCV_SMODE=y
+CONFIG_FIT=y
+CONFIG_SPL_LOAD_FIT_ADDRESS=0xa0000000
+CONFIG_OF_BOARD_SETUP=y
+CONFIG_BOOTDELAY=1
+#CONFIG_USE_BOOTCOMMAND is not set
+#CONFIG_BOOTCOMMAND="dhcp; tftp 0x83000000 129.132.24.199:vcu128-01/Image.itb; bootm 0x83000000"
+CONFIG_USE_BOOTARGS=y
+CONFIG_BOOTARGS="earlyprintk"
+CONFIG_LOG=y
+CONFIG_LOG_MAX_LEVEL=9
+CONFIG_LOGF_FUNC=y
+CONFIG_LOG_ERROR_RETURN=y
+CONFIG_DISPLAY_CPUINFO=y
+#CONFIG_SPL_MTD_SUPPORT is not set
+#CONFIG_SPL_DM_SPI_FLASH is not set
+CONFIG_SPL_RAM_SUPPORT=y
+CONFIG_SPL_RAM_DEVICE=y
+#CONFIG_SPL_SPI_FLASH_MTD is not set
+#CONFIG_SPL_SPI_LOAD is not set
+#CONFIG_CMD_MEMTEST is not set
+#CONFIG_CMD_GPIO is not set
+#CONFIG_CMD_I2C is not set
+CONFIG_CMD_SF_TEST=y
+#CONFIG_CMD_AXI is not set
+#CONFIG_CMD_DHCP is not set
+#CONFIG_CMD_MII is not set
+#CONFIG_CMD_PING is not set
+#CONFIG_CMD_DNS is not set
+#CONFIG_CMD_MTDPARTS is not set
+CONFIG_CMD_FDT=y
+CONFIG_MTDIDS_DEFAULT="ramdisk0=ramdisk0.0"
+CONFIG_MTDPARTS_DEFAULT="mtdparts=ramdisk0.0:1m(u-boot),16m(uimage),143m(filesystem)"
+CONFIG_OF_PRIOR_STAGE=y
+#CONFIG_PROT_UDP is not set
+#CONFIG_NET_RANDOM_ETHADDR is not set
+#CONFIG_AXI is not set
+#CONFIG_DM_PCA953X is not set
+#CONFIG_DM_I2C is not set
+#CONFIG_SYS_I2C_XILINX_XIIC is not set
+#CONFIG_I2C_MUX is not set
+#CONFIG_I2C_MUX_PCA954x is not set
+#CONFIG_DM_MTD is not set
+#CONFIG_SPI_FLASH_ATMEL is not set
+#CONFIG_SPI_FLASH_EON is not set
+#CONFIG_SPI_FLASH_GIGADEVICE is not set
+#CONFIG_SPI_FLASH_ISSI is not set
+#CONFIG_SPI_FLASH_MACRONIX is not set
+#CONFIG_SPI_FLASH_SPANSION is not set
+#CONFIG_SPI_FLASH_STMICRO is not set
+#CONFIG_SPI_FLASH_SST is not set
+#CONFIG_SPI_FLASH_WINBOND is not set
+#CONFIG_SPI_FLASH_XMC is not set
+# CONFIG_SPI_FLASH_USE_4K_SECTORS is not set
+#CONFIG_SPI_FLASH_MTD is not set
+#CONFIG_PHY_TI_DP83867 is not set
+#CONFIG_PHY_XILINX is not set
+#CONFIG_DM_MDIO is not set
+#CONFIG_DM_ETH_PHY is not set
+#CONFIG_XILINX_AXIEMAC is not set
+#CONFIG_PHY is not set
+CONFIG_SYS_NS16550=y
+#CONFIG_SPI is not set
+#CONFIG_XILINX_SPI is not set
+CONFIG_CLINT_TIMER=y
+#CONFIG_SPL_OS_BOOT is not set
+CONFIG_FIT_SIGNATURE=y
\ No newline at end of file
diff --git a/drivers/core/lists.c b/drivers/core/lists.c
index e214306b90..b52377eace 100644
--- a/drivers/core/lists.c
+++ b/drivers/core/lists.c
@@ -198,17 +198,18 @@ int lists_bind_fdt(struct udevice *parent, ofnode node, struct udevice **devp,
 	if (devp)
 		*devp = NULL;
 	name = ofnode_get_name(node);
-	log_debug("bind node %s\n", name);
+
+	debug("bind node, name = \"%s\"\n", name);
 
 	compat_list = ofnode_get_property(node, "compatible", &compat_length);
 	if (!compat_list) {
 		if (compat_length == -FDT_ERR_NOTFOUND) {
-			log_debug("Device '%s' has no compatible string\n",
+			debug("Device '%s' has no compatible string\n",
 				  name);
 			return 0;
 		}
 
-		dm_warn("Device tree error at node '%s'\n", name);
+		debug("Device tree error at node '%s'\n", name);
 		return compat_length;
 	}
 
@@ -219,7 +220,7 @@ int lists_bind_fdt(struct udevice *parent, ofnode node, struct udevice **devp,
 	 */
 	for (i = 0; i < compat_length; i += strlen(compat) + 1) {
 		compat = compat_list + i;
-		log_debug("   - attempt to match compatible string '%s'\n",
+		debug("   - attempt to match compatible string '%s'\n",
 			  compat);
 
 		for (entry = driver; entry != driver + n_ents; entry++) {
@@ -234,22 +235,22 @@ int lists_bind_fdt(struct udevice *parent, ofnode node, struct udevice **devp,
 		if (pre_reloc_only) {
 			if (!ofnode_pre_reloc(node) &&
 			    !(entry->flags & DM_FLAG_PRE_RELOC)) {
-				log_debug("Skipping device pre-relocation\n");
+				debug("Skipping device pre-relocation\n");
 				return 0;
 			}
 		}
 
-		log_debug("   - found match at '%s': '%s' matches '%s'\n",
+		debug("   - found match at '%s': '%s' matches '%s'\n",
 			  entry->name, entry->of_match->compatible,
 			  id->compatible);
 		ret = device_bind_with_driver_data(parent, entry, name,
 						   id->data, node, &dev);
 		if (ret == -ENODEV) {
-			log_debug("Driver '%s' refuses to bind\n", entry->name);
+			debug("Driver '%s' refuses to bind\n", entry->name);
 			continue;
 		}
 		if (ret) {
-			dm_warn("Error binding driver '%s': %d\n", entry->name,
+			debug("Error binding driver '%s': %d\n", entry->name,
 				ret);
 			return log_msg_ret("bind", ret);
 		} else {
@@ -261,7 +262,7 @@ int lists_bind_fdt(struct udevice *parent, ofnode node, struct udevice **devp,
 	}
 
 	if (!found && !result && ret != -ENODEV)
-		log_debug("No match for node '%s'\n", name);
+		debug("No match for node '%s'\n", name);
 
 	return result;
 }
diff --git a/drivers/core/root.c b/drivers/core/root.c
index fe0562cd6f..f74f045e87 100644
--- a/drivers/core/root.c
+++ b/drivers/core/root.c
@@ -273,8 +273,10 @@ static int dm_scan_fdt_node(struct udevice *parent, ofnode parent_node,
 	     node = ofnode_next_subnode(node)) {
 		const char *node_name = ofnode_get_name(node);
 
+		debug("dm_scan_fdt_node: node name =  \"%s\"\n", node_name);
+
 		if (!ofnode_is_enabled(node)) {
-			pr_debug("   - ignoring disabled device\n");
+			debug("   - ignoring disabled device\n");
 			continue;
 		}
 		err = lists_bind_fdt(parent, node, NULL, pre_reloc_only);
@@ -400,7 +402,7 @@ int dm_init_and_scan(bool pre_reloc_only)
 	if (!CONFIG_IS_ENABLED(OF_PLATDATA_INST)) {
 		ret = dm_scan(pre_reloc_only);
 		if (ret) {
-			log_debug("dm_scan() failed: %d\n", ret);
+			debug("dm_scan() failed: %d\n", ret);
 			return ret;
 		}
 	}
diff --git a/include/configs/pulp-platform_occamy.h b/include/configs/pulp-platform_occamy.h
new file mode 100644
index 0000000000..b64000ffef
--- /dev/null
+++ b/include/configs/pulp-platform_occamy.h
@@ -0,0 +1,39 @@
+#ifndef __CONFIG_H
+#define __CONFIG_H
+
+#include <linux/sizes.h>
+
+#define CONFIG_TFTP_TSIZE
+
+// fdt_high=~0UL to use FDT in-place
+#define CONFIG_EXTRA_ENV_SETTINGS \
+	"fdt_high=0xe0000000\0" \
+	"tftptimeout=1000\0" \
+	"tftptimeoutcountmax=1000\0"
+
+#ifdef CONFIG_SPL
+#define CONFIG_SPL_MAX_SIZE		0x00020000
+
+#define CONFIG_SPL_BSS_START_ADDR	0xb2018000
+#define CONFIG_SPL_BSS_MAX_SIZE		0x00008000
+
+// We need more space than the SPM can provide, so put the heap into HBM.
+// malloc should only be available _after_ the HBM is initialised.
+#define CONFIG_SYS_SPL_MALLOC_START	0xb4000000
+#define CONFIG_SYS_SPL_MALLOC_SIZE	0x00100000
+
+#define CONFIG_SPL_STACK	0xb2018000
+#endif
+
+// OpenSBI is at 0x80000000
+#define CONFIG_SYS_SDRAM_BASE		0xb0200000
+#define CONFIG_SYS_INIT_SP_ADDR		(CONFIG_SYS_SDRAM_BASE + SZ_2M)
+
+#define CONFIG_SYS_LOAD_ADDR		(CONFIG_SYS_SDRAM_BASE + SZ_2M)
+
+#define CONFIG_SYS_MALLOC_LEN       SZ_8M
+#define CONFIG_SYS_BOOTM_LEN        SZ_128M
+
+#define CONFIG_SYS_MAX_FLASH_BANKS 1
+#define CONFIG_SYS_FLASH_BASE 0x0
+#endif
diff --git a/include/init.h b/include/init.h
index fd51d7f966..287b796576 100644
--- a/include/init.h
+++ b/include/init.h
@@ -10,6 +10,11 @@
 #ifndef __INIT_H_
 #define __INIT_H_	1
 
+#define OCCAMY_LOG_BASE (0xb9000000)
+
+int _occamy_puts (const char *msg);
+int _occamy_putc (const char c);
+
 #ifndef __ASSEMBLY__		/* put C only stuff in this section */
 
 #include <linux/types.h>
diff --git a/include/log.h b/include/log.h
index add3a1e4a0..6dbf59c38b 100644
--- a/include/log.h
+++ b/include/log.h
@@ -15,6 +15,9 @@
 #include <linux/bitops.h>
 #include <linux/list.h>
 
+int _occamy_putc (const char c);
+int _occamy_puts (const char *msg);
+
 struct cmd_tbl;
 
 /**
@@ -210,6 +213,10 @@ static inline int _log_nop(enum log_category_t cat, enum log_level_t level,
 		      __func__, pr_fmt(_fmt), ##_args); \
 })
 
+#ifndef DEBUG
+#define DEBUG
+#endif
+
 #ifdef DEBUG
 #define _DEBUG	1
 #else
diff --git a/lib/display_options.c b/lib/display_options.c
index cd48998b6d..cb7cdb6bfb 100644
--- a/lib/display_options.c
+++ b/lib/display_options.c
@@ -153,7 +153,7 @@ int print_buffer(ulong addr, const void *data, uint width, uint count,
 
 	while (count) {
 		uint thislinelen = linelen;
-		printf("%08lx:", addr);
+		debug("%08lx:", addr);
 
 		/* check for overflow condition */
 		if (count < thislinelen)
@@ -170,16 +170,16 @@ int print_buffer(ulong addr, const void *data, uint width, uint count,
 			else
 				x = lb.uc[i] = *(volatile uint8_t *)data;
 			if (CONFIG_IS_ENABLED(USE_TINY_PRINTF))
-				printf(" %x", (uint)x);
+				debug(" %x", (uint)x);
 			else
-				printf(" %0*lx", width * 2, x);
+				debug(" %0*lx", width * 2, x);
 			data += width;
 		}
 
 		while (thislinelen < linelen) {
 			/* fill line with whitespace for nice ASCII print */
 			for (i=0; i<width*2+1; i++)
-				puts(" ");
+				debug(" ");
 			linelen--;
 		}
 
@@ -189,7 +189,7 @@ int print_buffer(ulong addr, const void *data, uint width, uint count,
 				lb.uc[i] = '.';
 		}
 		lb.uc[i] = '\0';
-		printf("    %s\n", lb.uc);
+		debug("    %s\n", lb.uc);
 
 		/* update references */
 		addr += thislinelen * width;
diff --git a/lib/fdtdec.c b/lib/fdtdec.c
index 4b097fb588..0869e514b9 100644
--- a/lib/fdtdec.c
+++ b/lib/fdtdec.c
@@ -596,16 +596,18 @@ int fdtdec_check_fdt(void)
  */
 int fdtdec_prepare_fdt(void)
 {
+	int header;
 	if (!gd->fdt_blob || ((uintptr_t)gd->fdt_blob & 3) ||
-	    fdt_check_header(gd->fdt_blob)) {
+	    (header = fdt_check_header(gd->fdt_blob))) {
+		debug("fdt_check_header: return code = %d\n", header);
 #ifdef CONFIG_SPL_BUILD
-		puts("Missing DTB\n");
+		debug("Missing DTB\n");
 #else
-		printf("No valid device tree binary found at %p\n",
+		debug("No valid device tree binary found at %p\n",
 		       gd->fdt_blob);
 # ifdef DEBUG
 		if (gd->fdt_blob) {
-			printf("fdt_blob=%p\n", gd->fdt_blob);
+			debug("fdt_blob=%p\n", gd->fdt_blob);
 			print_buffer((ulong)gd->fdt_blob, gd->fdt_blob, 4,
 				     32, 0);
 		}
@@ -1609,6 +1611,8 @@ int fdtdec_setup(void)
 # endif
 #endif
 
+	debug("fdtdec_setup: gd->fdt_blob = %p\n", gd->fdt_blob);
+
 	ret = fdtdec_prepare_fdt();
 	if (!ret)
 		ret = fdtdec_board_setup(gd->fdt_blob);
diff --git a/lib/tiny-printf.c b/lib/tiny-printf.c
index 8fc7e48d99..60d56fbcbc 100644
--- a/lib/tiny-printf.c
+++ b/lib/tiny-printf.c
@@ -13,6 +13,9 @@
 #include <serial.h>
 #include <linux/ctype.h>
 
+int _occamy_putc (const char c);
+int _occamy_puts (const char *msg);
+
 struct printf_info {
 	char *bf;	/* Digit buffer */
 	char zs;	/* non-zero if a digit has been written */
@@ -207,6 +210,7 @@ static int _vprintf(struct printf_info *info, const char *fmt, va_list va)
 	while ((ch = *(fmt++))) {
 		if (ch != '%') {
 			info->putc(info, ch);
+			_occamy_putc(ch);
 		} else {
 			bool lz = false;
 			int width = 0;
@@ -314,11 +318,15 @@ static int _vprintf(struct printf_info *info, const char *fmt, va_list va)
 			info->bf = p;
 			while (*info->bf++ && width > 0)
 				width--;
-			while (width-- > 0)
+			while (width-- > 0) {
 				info->putc(info, lz ? '0' : ' ');
+				_occamy_putc(lz ? '0' : ' ');
+			}
 			if (p) {
-				while ((ch = *p++))
+				while ((ch = *p++)) {
+					_occamy_putc(ch);
 					info->putc(info, ch);
+				}
 			}
 		}
 	}
-- 
2.34.1

